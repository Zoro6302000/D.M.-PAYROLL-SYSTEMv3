<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D.M. MALIWANAG BUILDERS AND ENTERPRISES - Payroll System</title>
  <style >
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { margin:0; font-size:32px; font-weight:bold; text-align:left; }
    h2 { margin:0; font-size:24px; font-weight:normal; text-align:center; }
    .by { text-align:center; font-size:16px; margin-bottom:15px; }
    .date { text-align: center; margin: 20px 0; font-weight: bold; }
    nav { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background: #333; color: #fff; }
    input, select { padding: 4px; }
    input[type=text] { text-transform: uppercase; width: 250px; }
    input[type=number] { width: 100px; text-align: center; }
    .nameInput { width: 100%; min-width:200px; text-transform: uppercase; box-sizing: border-box; }
    button {
      padding: 10px 18px;
      background: linear-gradient(90deg, #004aad, #0073e6);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }
    button:hover { background: linear-gradient(90deg, #0073e6, #004aad); transform: translateY(-2px); }
    .hidden { display: none; }
    #summary { margin-top: 30px; background: #fff; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <!-- Header with Logo and Company Info -->
  <div style="display:flex;align-items:center;justify-content:center;gap:15px;">
    <img src="DM LOGO.png" alt="Company Logo" style="height:120px;">
    <div>
      <h1>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h1>
    </div>
  </div>

  <!-- Centered Payroll Title -->
  <div style="text-align:center;margin-top:5px;">
    <h2 style="margin:5px 0;font-size:30px;">Payroll System</h2>
    <div style="font-size:12px;">by: Wenjunzxc</div>
  </div>

  <!-- Payroll Period -->
  <div class="date">
    Payroll Period: 
    <input type="date" id="payrollFrom"> to 
    <input type="date" id="payrollTo">
  </div>

  <!-- Navigation -->
  <nav>
    <button onclick="showInterface('dashboard')">Dashboard</button>
    <button onclick="showInterface('site')">Per Site Payroll</button>
    <button onclick="addNewSite()">Add New Site</button>
  </nav>

  <!-- DASHBOARD -->
  <div id="dashboardInterface">
    <h2 style="text-align:center;">Welcome to the Payroll System</h2>
    <p style="text-align:center;">This dashboard provides an overview of all projects and payroll summaries.</p>
    <div id="summary">
      <h3>Payroll Summary by Site</h3>
      <table id="siteSummary">
        <thead>
          <tr>
            <th>Site</th>
            <th>Total Gross</th>
            <th>Total Deductions</th>
            <th>Total Net</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>GRAND TOTAL</th>
            <th id="grandGross">₱0.00</th>
            <th id="grandDeductions">₱0.00</th>
            <th id="grandNet">₱0.00</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
      <br>
      <button onclick="printSummary()">Print Payroll Summary</button>
      <button onclick="exportCSV()">Export Payroll to CSV</button>
      <!-- Backup / Restore controls -->
      <button onclick="exportJSON()">Export Backup</button>
      <button onclick="document.getElementById('jsonImport').click()">Import Backup</button>
      <input id="jsonImport" type="file" accept="application/json" style="display:none" onchange="importJSON(event)">
    </div>
  </div>

  <!-- PER SITE -->
  <div id="siteInterface" class="hidden">
    <label for="perSiteSelect"><strong>Select Site:</strong></label>
    <select id="perSiteSelect" onchange="renderSiteTable()"></select>
    <button onclick="addEmployeeToSite()">Add Employee to This Site</button>
    <button onclick="deleteSite()">Delete Site</button>
    <button onclick="printSitePayroll()">Print This Site Payroll</button>

    <div id="sitePayrollArea">
      <table id="perSiteTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Rate/Day</th>
            <th>Days Worked</th>
            <th>OT Hours</th>
            <th>Gross Pay</th>
            <th>Cash Advance</th>
            <th>Benefits</th>
            <th>Net Pay</th>
            <th>Signature</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br>
      <div id="perSiteSummary">
        <h3>Summary for Selected Site</h3>
        <table>
          <thead>
            <tr>
              <th>Total Gross</th>
              <th>Total Deductions</th>
              <th>Total Net</th>
            </tr>
          </thead>
          <tbody id="perSiteSummaryBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "dmPayrollStateV1";

    let siteTotals = {};
    let sites = [];
    let siteData = {};
    let selectedSite = "";

    function pesoFormat(num) {
      return "₱" + (parseFloat(num)||0).toLocaleString("en-PH",{minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function getMaxDays() {
      const from=document.getElementById("payrollFrom").value;
      const to=document.getElementById("payrollTo").value;
      if(from && to){
        const start=new Date(from);const end=new Date(to);
        return Math.floor((end-start)/(1000*60*60*24))+1;
      }
      return 0;
    }

    function showInterface(mode){
      document.getElementById("dashboardInterface").classList.add("hidden");
      document.getElementById("siteInterface").classList.add("hidden");
      if(mode==="dashboard"){document.getElementById("dashboardInterface").classList.remove("hidden");computePayroll();}
      else {document.getElementById("siteInterface").classList.remove("hidden");renderSiteOptions();renderSiteTable();}
    }

    function addNewSite(){
      const input = prompt("Enter new site name:");
      if(!input) return;
      const siteName = input.toUpperCase();
      if(!sites.includes(siteName)){
        sites.push(siteName);
        const select=document.getElementById("perSiteSelect");
        const option=document.createElement("option");
        option.value=siteName;
        option.textContent=siteName;
        select.appendChild(option);
        siteData[siteName]=[];
        select.value=siteName; // auto-select
        selectedSite = siteName;
        renderSiteTable();
        saveState();
      } else {
        alert("Site already exists.");
        document.getElementById("perSiteSelect").value=siteName;
        selectedSite = siteName;
        renderSiteTable();
        saveState();
      }
    }

    function deleteSite(){
      const select=document.getElementById("perSiteSelect");
      const siteName=select.value;
      if(!siteName){alert("Please select a site to delete.");return;}
      if(confirm("Are you sure you want to delete site: "+siteName+" ?")){
        sites=sites.filter(s=>s!==siteName);
        delete siteData[siteName];
        [...select.options].forEach(opt=>{if(opt.value===siteName) opt.remove();});
        document.querySelector("#perSiteTable tbody").innerHTML="";
        document.getElementById("perSiteSummaryBody").innerHTML="";
        selectedSite = sites[0] || "";
        renderSiteOptions();
        saveState();
        alert("Site deleted successfully.");
        computePayroll();
      }
    }

    function addEmployeeToSite(){
      const site=document.getElementById("perSiteSelect").value;
      if(!site){alert("Please add or select a site first.");return;}
      if(!siteData[site]) siteData[site]=[];
      siteData[site].push({name:"",rate:"",days:"",ot:"",gross:0,advance:"",benefits:"",net:0});
      renderSiteTable();
      saveState();
    }

    function renderSiteOptions(){
      const select=document.getElementById("perSiteSelect");
      const current = select.value;
      select.innerHTML="";
      sites.forEach(s=>{
        const opt=document.createElement("option");
        opt.value=s; opt.textContent=s;
        select.appendChild(opt);
      });
      if(selectedSite && sites.includes(selectedSite)) {
        select.value = selectedSite;
      } else if (current && sites.includes(current)) {
        select.value = current;
      } else if (sites.length) {
        select.value = sites[0];
      }
    }

    function renderSiteTable(){
      const site=document.getElementById("perSiteSelect").value;
      selectedSite = site || selectedSite;
      const tbody=document.querySelector("#perSiteTable tbody");
      tbody.innerHTML="";
      if(!site||!siteData[site]) return;
      siteData[site].forEach((emp,idx)=>{
        const gross=(parseFloat(emp.rate)||0)*(parseFloat(emp.days)||0)+((parseFloat(emp.ot)||0)*(parseFloat(emp.rate)||0)/8);
        const deductions=(parseFloat(emp.advance)||0)+(parseFloat(emp.benefits)||0);
        const net=gross-deductions;
        emp.gross=gross;emp.net=net;
        const row=document.createElement("tr");
        row.innerHTML=`
          <td><input type="text" class="nameInput" style="width:auto;min-width:200px;" value="${emp.name}" 
            oninput="this.value=this.value.toUpperCase(); updateEmployee('${site}',${idx},'name',this.value)" 
            onkeydown="focusNext(event,this)" placeholder="NAME"></td>
          <td><input type="number" value="${emp.rate?emp.rate:''}" class="rate" step="0.01" 
            oninput="updateEmployee('${site}',${idx},'rate',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td><input type="number" value="${emp.days?emp.days:''}" class="days" step="0.5"
            onblur="validateHalfStep(this,'${site}',${idx},'days')" 
            onkeydown="focusNext(event,this)" placeholder="Days (Max ${getMaxDays()})"></td>
          <td><input type="number" value="${emp.ot?emp.ot:''}" class="ot" step="0.5"
            onblur="validateHalfStep(this,'${site}',${idx},'ot')" 
            onkeydown="focusNext(event,this)" placeholder="OT"></td>
          <td class="gross">${pesoFormat(emp.gross)}</td>
          <td><input type="number" value="${emp.advance?emp.advance:''}" class="advance" step="0.01"
            oninput="updateEmployee('${site}',${idx},'advance',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td><input type="number" value="${emp.benefits?emp.benefits:''}" class="benefits" step="0.01"
            oninput="updateEmployee('${site}',${idx},'benefits',this.value)" onkeydown="focusNext(event,this)" placeholder="₱"></td>
          <td class="net">${pesoFormat(emp.net)}</td>
          <td style="height:40px;"></td>
        `;
        tbody.appendChild(row);
      });
      computePayroll();
    }

    function focusNext(e,input){
      if(e.key==="Enter"){
        e.preventDefault();
        let inputs=Array.from(input.closest("tr").querySelectorAll("input,select"));
        let idx=inputs.indexOf(input);
        if(idx>=0 && idx<inputs.length-1){inputs[idx+1].focus();}
        else{input.blur();}
        computePayroll();
      }
    }

    function validateHalfStep(input, site, idx, field){
      let raw=input.value;
      if(raw===".") raw="0.5";
      else if(raw.startsWith(".")&&raw.length>1){raw="0"+raw;}
      let val=parseFloat(raw)||0;
      const maxDays=getMaxDays();
      val=Math.round(val*2)/2;
      if(val<0) val=0;
      if(field==="days"&&maxDays>0&&val>maxDays){
        alert("Days worked cannot exceed ("+maxDays+") days.");
        val=maxDays;
      }
      input.value=val||"";
      siteData[site][idx][field]=val;
      computePayroll();
      saveState();
    }

    function updateEmployee(site,idx,field,value){
      let num=parseFloat(value);
      if(isNaN(num)) num=0;
      if(["advance","benefits","rate"].includes(field)&&num<0) num=0;
      siteData[site][idx][field]=(field==="name"?value:num);
      computePayroll();
      saveState();
    }

    function computePayroll(){
      siteTotals={};
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          const gross=(parseFloat(emp.rate)||0)*(parseFloat(emp.days)||0)+((parseFloat(emp.ot)||0)*(parseFloat(emp.rate)||0)/8);
          const deductions=(parseFloat(emp.advance)||0)+(parseFloat(emp.benefits)||0);
          const net=gross-deductions;
          emp.gross=gross;emp.net=net;
          if(!siteTotals[site]) siteTotals[site]={gross:0,deductions:0,net:0};
          siteTotals[site].gross+=gross;
          siteTotals[site].deductions+=deductions;
          siteTotals[site].net+=net;
        });
      }
      updateDashboardSummary();
      updatePerSiteSummary();
      refreshTables();
    }

    function refreshTables(){
      const site=document.getElementById("perSiteSelect").value;
      if(site&&siteData[site]){
        const rows=document.querySelectorAll("#perSiteTable tbody tr");
        rows.forEach((row,idx)=>{
          row.querySelector(".gross").textContent=pesoFormat(siteData[site][idx].gross||0);
          row.querySelector(".net").textContent=pesoFormat(siteData[site][idx].net||0);
        });
      }
    }

    function updateDashboardSummary(){
      const tbody=document.querySelector("#siteSummary tbody");
      tbody.innerHTML="";
      let gGross=0,gDed=0,gNet=0;
      for(let site in siteTotals){
        tbody.innerHTML+=`<tr>
          <td>${site}</td>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
          <td style="height:40px;"></td>
        </tr>`;
        gGross+=siteTotals[site].gross; gDed+=siteTotals[site].deductions; gNet+=siteTotals[site].net;
      }
      document.getElementById("grandGross").textContent=pesoFormat(gGross);
      document.getElementById("grandDeductions").textContent=pesoFormat(gDed);
      document.getElementById("grandNet").textContent=pesoFormat(gNet);
    }

    function updatePerSiteSummary(){
      const site=document.getElementById("perSiteSelect").value;
      const tbody=document.getElementById("perSiteSummaryBody");
      tbody.innerHTML="";
      if(siteTotals[site]){
        tbody.innerHTML=`<tr>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
        </tr>`;
      }
    }

    // Dashboard print (clean layout, includes Payroll Period)
    function printSummary(){
      const from=document.getElementById("payrollFrom").value;
      const to=document.getElementById("payrollTo").value;
      const period=(from && to) ? `Payroll Period: ${from} to ${to}` : "";

      let rows = `<table border="1" cellspacing="0" cellpadding="6" width="100%">
        <thead>
          <tr>
            <th>Site</th>
            <th>Total Gross</th>
            <th>Total Deductions</th>
            <th>Total Net</th>
          </tr>
        </thead><tbody>`;

      let gGross=0,gDed=0,gNet=0;
      for(let site in siteTotals){
        rows+=`<tr>
          <td>${site}</td>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
        </tr>`;
        gGross+=siteTotals[site].gross;
        gDed+=siteTotals[site].deductions;
        gNet+=siteTotals[site].net;
      }

      rows+=`<tr>
        <th>GRAND TOTAL</th>
        <th>${pesoFormat(gGross)}</th>
        <th>${pesoFormat(gDed)}</th>
        <th>${pesoFormat(gNet)}</th>
      </tr></tbody></table>`;

      const win=window.open("","_blank");
      win.document.write(`
        <html><head><title>Payroll Summary</title>
        <style>
          body{font-family:Arial, sans-serif;margin:40px;}
          h1,h2,h3{text-align:center;margin:5px 0;}
          table{width:100%;border-collapse:collapse;margin-top:20px;}
          th,td{border:1px solid #000;padding:6px;text-align:center;}
          th{background:#ddd;}
        </style></head><body>
          <h1>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h1>
          <h2>Payroll Summary Report</h2>
          <h3>${period}</h3>
          ${rows}
        </body></html>
      `);
      win.print();
      win.close();
    }

    function printSitePayroll(){
      const site=document.getElementById("perSiteSelect").value;
      if(!site){alert("Please select a site first.");return;}
      const from=document.getElementById("payrollFrom").value;
      const to=document.getElementById("payrollTo").value;
      const period=(from && to)?`Payroll Period: ${from} to ${to}`:"";
      let rows=`<table border="1" cellspacing="0" cellpadding="6" width="100%"><thead><tr><th>Name</th><th>Rate/Day</th><th>Days Worked</th><th>OT Hours</th><th>Gross Pay</th><th>Cash Advance</th><th>Benefits</th><th>Net Pay</th><th>Signature</th></tr></thead><tbody>`;
      siteData[site].forEach(emp=>{
        rows+=`<tr>
          <td>${emp.name}</td>
          <td>${pesoFormat(emp.rate)}</td>
          <td>${emp.days}</td>
          <td>${emp.ot}</td>
          <td>${pesoFormat(emp.gross)}</td>
          <td>${pesoFormat(emp.advance)}</td>
          <td>${pesoFormat(emp.benefits)}</td>
          <td>${pesoFormat(emp.net)}</td>
          <td style="height:40px;"></td>
        </tr>`;
      });
      rows+="</tbody></table>";
      const win=window.open("","_blank");
      win.document.write(`
        <html><head><title>Payroll Report - ${site}</title>
        <style>
          body{font-family:Arial,sans-serif;margin:40px;}
          h1,h2,h3{text-align:center;margin:5px 0;}
          table{width:100%;border-collapse:collapse;margin-top:20px;}
          th,td{border:1px solid #000;padding:6px;text-align:center;}
          th{background:#ddd;}
          footer{margin-top:60px;text-align:right;font-size:14px;}
        </style></head><body>
          <h1>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h1>
          <h2>Payroll Report - ${site}</h2>
          <h3>${period}</h3>
          ${rows}
          <footer>
            <div style="margin-top:60px;">
              Approved by:<br><br><br>
              <u>DANA MALIWANAG</u><br>
              Signature over printed name
            </div>
          </footer>
        </body></html>
      `);
      win.print();
      win.close();
    }

    function exportCSV(){
      let csv="Site,Name,Rate,Days Worked,OT Hours,Gross,Cash Advance,Benefits,Net\n";
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          csv+=`${site},${emp.name},${emp.rate},${emp.days},${emp.ot},${emp.gross},${emp.advance},${emp.benefits},${emp.net}\n`;
        });
      }
      const blob=new Blob([csv],{type:"text/csv"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="payroll.csv";
      link.click();
    }

    // Backup / Restore JSON
    function exportJSON(){
      const from = document.getElementById("payrollFrom").value || "";
      const to   = document.getElementById("payrollTo").value || "";
      const payload = {
        version: "1.0",
        exportedAt: new Date().toISOString(),
        sites,
        siteData,
        selectedSite: document.getElementById("perSiteSelect")?.value || "",
        period: { from, to }
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      const y = new Date();
      const pad = n => String(n).padStart(2,"0");
      a.href = URL.createObjectURL(blob);
      a.download = `payroll-backup-${y.getFullYear()}${pad(y.getMonth()+1)}${pad(y.getDate())}.json`;
      a.click();
    }

    function importJSON(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.sites) || typeof data.siteData !== "object"){
            alert("Invalid backup file."); 
            e.target.value = ""; 
            return;
          }
          sites = data.sites;
          siteData = data.siteData;
          selectedSite = data.selectedSite || "";
          document.getElementById("payrollFrom").value = data.period?.from || "";
          document.getElementById("payrollTo").value   = data.period?.to   || "";
          renderSiteOptions();
          const select = document.getElementById("perSiteSelect");
          if(selectedSite && sites.includes(selectedSite)) select.value = selectedSite;
          renderSiteTable();
          computePayroll();
          saveState();
          alert("Backup imported.");
        }catch(err){
          alert("Failed to import backup.");
        }finally{
          e.target.value = "";
        }
      };
      reader.readAsText(file);
    }

    // Persistence
    function saveState(){
      const from=document.getElementById("payrollFrom").value || "";
      const to=document.getElementById("payrollTo").value || "";
      try{
        const data={sites, siteData, selectedSite: document.getElementById("perSiteSelect")?.value || selectedSite, from, to};
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }catch(e){}
    }

    function loadState(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const data=JSON.parse(raw);
        sites = Array.isArray(data.sites)?data.sites:[];
        siteData = typeof data.siteData==="object" && data.siteData? data.siteData : {};
        selectedSite = data.selectedSite || "";
        if(data.from) document.getElementById("payrollFrom").value = data.from;
        if(data.to) document.getElementById("payrollTo").value = data.to;
      }catch(e){}
    }

    // Init
    document.addEventListener("DOMContentLoaded",()=>{
      loadState();
      renderSiteOptions();
      if(selectedSite && sites.includes(selectedSite)){
        document.getElementById("perSiteSelect").value = selectedSite;
      }
      computePayroll();
      document.getElementById("payrollFrom").addEventListener("change", ()=>{renderSiteTable(); computePayroll(); saveState();});
      document.getElementById("payrollTo").addEventListener("change", ()=>{renderSiteTable(); computePayroll(); saveState();});
      document.getElementById("perSiteSelect").addEventListener("change", (e)=>{selectedSite=e.target.value; saveState();});
    });
  </script>
</body>
</html>
