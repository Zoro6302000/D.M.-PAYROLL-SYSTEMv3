<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D.M. MALIWANAG BUILDERS AND ENTERPRISES - Payroll System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { font-size:32px; text-align:center; margin-bottom: 10px; }
    h2, h3 { text-align:center; margin:5px 0; }
    .date { text-align: center; margin: 20px 0; }
    nav { text-align: center; margin-bottom: 20px; }
    table { border-collapse: collapse; margin-top: 20px; width: auto; background:#fff; }
    th, td { border: 1px solid #000; padding: 6px; text-align: center; }
    th { background:#333; color:#fff; }
    .nameInput { width: 100%; text-transform: uppercase; }
    button { padding:6px 12px; margin:4px; border:none; border-radius:8px; background:#0073e6; color:#fff; cursor:pointer; }
    button:hover { background:#005bb5; }
    .hidden { display:none; }
    #summary { margin-top:20px; background:#fff; padding:10px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <div style="text-align:center;">
    <h1>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h1>
    <h2>Payroll System</h2>
    <p style="font-size:12px;">by: Wenjunzxc</p>
  </div>

  <div class="date">
    Payroll Period:
    <input type="date" id="payrollFrom"> to 
    <input type="date" id="payrollTo">
  </div>

  <nav>
    <button onclick="showInterface('dashboard')">Dashboard</button>
    <button onclick="showInterface('site')">Per Site Payroll</button>
    <button onclick="addNewSite()">Add New Site</button>
    <button onclick="clearAllData()">Clear All Data</button>
  </nav>

  <!-- DASHBOARD -->
  <div id="dashboardInterface">
    <h2>Dashboard</h2>
    <div id="summary">
      <h3>Payroll Summary by Site</h3>
      <table id="siteSummary">
        <thead>
          <tr>
            <th>Site</th>
            <th>Total Gross</th>
            <th>Total Deductions</th>
            <th>Total Net</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>GRAND TOTAL</th>
            <th id="grandGross">₱0.00</th>
            <th id="grandDeductions">₱0.00</th>
            <th id="grandNet">₱0.00</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
      <br>
      <button onclick="printSummary()">Print Payroll Summary</button>
      <button onclick="exportCSV()">Export Payroll to CSV</button>
    </div>
  </div>

  <!-- SITE PAYROLL -->
  <div id="siteInterface" class="hidden">
    <label for="perSiteSelect"><strong>Select Site:</strong></label>
    <select id="perSiteSelect" onchange="renderSiteTable()"></select>
    <button onclick="addEmployeeToSite()">Add Employee</button>
    <button onclick="deleteSite()">Delete Site</button>
    <button onclick="printSitePayroll()">Print This Site</button>

    <div id="sitePayrollArea">
      <table id="perSiteTable">
        <thead>
          <tr>
            <th>Name</th><th>Rate/Day</th><th>Days Worked</th><th>OT Hours</th>
            <th>Gross Pay</th><th>Cash Advance</th><th>Benefits</th><th>Net Pay</th><th>Signature</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br>
      <div id="perSiteSummary">
        <h3>Site Totals</h3>
        <table>
          <tr>
            <th>Total Gross</th>
            <th>Total Deductions</th>
            <th>Total Net</th>
          </tr>
          <tr>
            <td id="siteTotalGross">₱0.00</td>
            <td id="siteTotalDeductions">₱0.00</td>
            <td id="siteTotalNet">₱0.00</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <script>
    let siteTotals = {};
    let sites = [];
    let siteData = {};

    function saveData() {
      localStorage.setItem("sites", JSON.stringify(sites));
      localStorage.setItem("siteData", JSON.stringify(siteData));
      console.log("Data saved:", sites, siteData);
    }

    function loadData(){
      const savedSites = localStorage.getItem("sites");
      const savedSiteData = localStorage.getItem("siteData");
      if(savedSites && savedSiteData){
        sites = JSON.parse(savedSites);
        siteData = JSON.parse(savedSiteData);

        const select=document.getElementById("perSiteSelect");
        select.innerHTML = "";
        sites.forEach(site=>{
          const option=document.createElement("option");
          option.value=site;
          option.textContent=site;
          select.appendChild(option);
        });

        computePayroll();
        console.log("Data loaded:", sites, siteData);
      }
    }

    function pesoFormat(num) {
      return "₱" + (parseFloat(num)||0).toLocaleString("en-PH",{minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function getMaxDays() {
      const from=document.getElementById("payrollFrom").value;
      const to=document.getElementById("payrollTo").value;
      if(from && to){
        const start=new Date(from);const end=new Date(to);
        return Math.floor((end-start)/(1000*60*60*24))+1;
      }
      return 0;
    }

    function showInterface(mode){
      document.getElementById("dashboardInterface").classList.add("hidden");
      document.getElementById("siteInterface").classList.add("hidden");
      if(mode==="dashboard"){document.getElementById("dashboardInterface").classList.remove("hidden");computePayroll();}
      else {document.getElementById("siteInterface").classList.remove("hidden");renderSiteTable();}
    }

    function addNewSite(){
      const input = prompt("Enter new site name:");
      if(!input) return;
      const siteName = input.toUpperCase();
      if(!sites.includes(siteName)){
        sites.push(siteName);
        const select=document.getElementById("perSiteSelect");
        const option=document.createElement("option");
        option.value=siteName;
        option.textContent=siteName;
        select.appendChild(option);
        siteData[siteName]=[];
        select.value=siteName;
        renderSiteTable();
        saveData();
      } else {
        alert("Site already exists.");
        document.getElementById("perSiteSelect").value=siteName;
        renderSiteTable();
      }
    }

    function deleteSite(){
      const select=document.getElementById("perSiteSelect");
      const siteName=select.value;
      if(!siteName){alert("Please select a site to delete.");return;}
      if(confirm("Are you sure you want to delete site: "+siteName+" ?")){
        sites=sites.filter(s=>s!==siteName);
        delete siteData[siteName];
        select.innerHTML="";
        sites.forEach(s=>{
          const option=document.createElement("option");
          option.value=s;
          option.textContent=s;
          select.appendChild(option);
        });
        document.querySelector("#perSiteTable tbody").innerHTML="";
        document.getElementById("perSiteSummaryBody").innerHTML="";
        saveData();
      }
    }

    function addEmployeeToSite(){
      const site=document.getElementById("perSiteSelect").value;
      if(!site){alert("Please add or select a site first.");return;}
      if(!siteData[site]) siteData[site]=[];
      siteData[site].push({name:"",rate:"",days:"",ot:"",gross:0,advance:"",benefits:"",net:0});
      renderSiteTable();
      saveData();
    }

    function renderSiteTable(){
      const site=document.getElementById("perSiteSelect").value;
      const tbody=document.querySelector("#perSiteTable tbody");
      tbody.innerHTML="";
      if(!site||!siteData[site]) return;
      siteData[site].forEach((emp,idx)=>{
        const gross=(parseFloat(emp.rate)||0)*(parseFloat(emp.days)||0)+((parseFloat(emp.ot)||0)*(parseFloat(emp.rate)||0)/8);
        const deductions=(parseFloat(emp.advance)||0)+(parseFloat(emp.benefits)||0);
        const net=gross-deductions;
        emp.gross=gross;emp.net=net;
        const row=document.createElement("tr");
        row.innerHTML=`
          <td><input type="text" class="nameInput" value="${emp.name}" 
            oninput="this.value=this.value.toUpperCase(); updateEmployee('${site}',${idx},'name',this.value)"></td>
          <td><input type="number" value="${emp.rate||''}" oninput="updateEmployee('${site}',${idx},'rate',this.value)"></td>
          <td><input type="number" value="${emp.days||''}" oninput="updateEmployee('${site}',${idx},'days',this.value)"></td>
          <td><input type="number" value="${emp.ot||''}" oninput="updateEmployee('${site}',${idx},'ot',this.value)"></td>
          <td class="gross">${pesoFormat(emp.gross||0)}</td>
          <td><input type="number" value="${emp.advance||''}" oninput="updateEmployee('${site}',${idx},'advance',this.value)"></td>
          <td><input type="number" value="${emp.benefits||''}" oninput="updateEmployee('${site}',${idx},'benefits',this.value)"></td>
          <td class="net">${pesoFormat(emp.net||0)}</td>
          <td></td>
        `;
        tbody.appendChild(row);
      });
      computePayroll();
    }

    function focusNext(e,input){
      if(e.key==="Enter"){
        e.preventDefault();
        let inputs=Array.from(input.closest("tr").querySelectorAll("input,select"));
        let idx=inputs.indexOf(input);
        if(idx>=0 && idx<inputs.length-1){inputs[idx+1].focus();}
        else{input.blur();}
        computePayroll();
      }
    }

    function validateHalfStep(input, site, idx, field){
      let raw=input.value;
      if(raw===".") raw="0.5";
      else if(raw.startsWith(".")&&raw.length>1){raw="0"+raw;}
      let val=parseFloat(raw)||0;
      const maxDays=getMaxDays();
      val=Math.round(val*2)/2;
      if(val<0) val=0;
      if(field==="days"&&maxDays>0&&val>maxDays){
        alert("Days worked cannot exceed ("+maxDays+") days.");
        val=maxDays;
      }
      input.value=val||"";
      siteData[site][idx][field]=val;
      computePayroll();
      saveData();
    }

    function updateEmployee(site,idx,field,value){
      let num=parseFloat(value);
      if(isNaN(num)) num=0;
      if(["advance","benefits","rate"].includes(field)&&num<0) num=0;
      siteData[site][idx][field]=(field==="name"?value:num);
      computePayroll();
      saveData();
    }

    function computePayroll(){
      siteTotals={};
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          const gross=(parseFloat(emp.rate)||0)*(parseFloat(emp.days)||0)+((parseFloat(emp.ot)||0)*(parseFloat(emp.rate)||0)/8);
          const deductions=(parseFloat(emp.advance)||0)+(parseFloat(emp.benefits)||0);
          const net=gross-deductions;
          emp.gross=gross;emp.net=net;
          if(!siteTotals[site]) siteTotals[site]={gross:0,deductions:0,net:0};
          siteTotals[site].gross+=gross;
          siteTotals[site].deductions+=deductions;
          siteTotals[site].net+=net;
        });
      }
      updateDashboardSummary();
      updatePerSiteSummary();
      refreshTables();
      saveData(); // <--- ensures data persists
    }

    function updateDashboardSummary(){
      const tbody=document.querySelector("#siteSummary tbody");
      tbody.innerHTML=""; 
      let gGross=0,gDed=0,gNet=0;
      for(let site in siteTotals){
        tbody.innerHTML+=`<tr>
          <td>${site}</td>
          <td>${pesoFormat(siteTotals[site].gross)}</td>
          <td>${pesoFormat(siteTotals[site].deductions)}</td>
          <td>${pesoFormat(siteTotals[site].net)}</td>
          <td></td>
        </tr>`;
        gGross+=siteTotals[site].gross; 
        gDed+=siteTotals[site].deductions; 
        gNet+=siteTotals[site].net;
      }
      document.getElementById("grandGross").textContent=pesoFormat(gGross);
      document.getElementById("grandDeductions").textContent=pesoFormat(gDed);
      document.getElementById("grandNet").textContent=pesoFormat(gNet);
    }

    function updatePerSiteSummary(){
      const site=document.getElementById("perSiteSelect").value;
      const totals = siteTotals[site] || {gross:0,deductions:0,net:0};
      document.getElementById("perSiteSummaryBody").innerHTML = `
        <tr>
          <td>${pesoFormat(totals.gross)}</td>
          <td>${pesoFormat(totals.deductions)}</td>
          <td>${pesoFormat(totals.net)}</td>
        </tr>`;
    }

    function printSummary(){ window.print(); }

    function printSitePayroll(){
      const site=document.getElementById("perSiteSelect").value;
      if(!site){alert("Please select a site first.");return;}

      let rows="";
      siteData[site].forEach(emp=>{
        rows+=`<tr>
          <td>${emp.name}</td><td>${emp.rate}</td><td>${emp.days}</td><td>${emp.ot}</td>
          <td>${pesoFormat(emp.gross)}</td><td>${pesoFormat(emp.advance)}</td><td>${pesoFormat(emp.benefits)}</td>
          <td>${pesoFormat(emp.net)}</td><td></td>
        </tr>`;
      });

      const totals = siteTotals[site] || {gross:0,deductions:0,net:0};
      rows+=`<tr>
        <td colspan="4"><strong>Total</strong></td>
        <td><strong>${pesoFormat(totals.gross)}</strong></td>
        <td><strong>${pesoFormat(totals.deductions)}</strong></td>
        <td><strong>${pesoFormat(totals.net)}</strong></td>
        <td></td>
      </tr>`;

      const win = window.open("", "_blank");
      win.document.write(`<html>
<head>
  <title>${site} Payroll</title>
  <style>
    @media print {
      body { margin: 10px; font-family: Arial, sans-serif; }
      h2, h3 { margin: 5px 0; text-align: center; }
      table { border-collapse: collapse; width: 100%; margin-top: 10px; }
      th, td { border: 1px solid #000; padding: 5px; text-align: center; }
    }
  </style>
</head>
<body>
  <h2>D.M. MALIWANAG BUILDERS AND ENTERPRISES</h2>
  <h3>Payroll Report - ${site}</h3>
  <h3>Payroll Period: ${document.getElementById("payrollFrom").value} to ${document.getElementById("payrollTo").value}</h3>
  <table>
    <thead>
      <tr>
        <th>Name</th><th>Rate/Day</th><th>Days Worked</th><th>OT Hours</th>
        <th>Gross Pay</th><th>Cash Advance</th><th>Benefits</th><th>Net Pay</th><th>Signature</th>
      </tr>
    </thead>
    <tbody>
      ${rows}
    </tbody>
  </table>
</body>
</html>`);
      win.print();
      win.close();
    }

    function exportCSV(){
      let csv="Site,Name,Rate,Days Worked,OT Hours,Gross,Tax/Other Deductions,Net\n";
      for(let site in siteData){
        siteData[site].forEach(emp=>{
          csv+=`${site},${emp.name},${emp.rate},${emp.days},${emp.ot},${pesoFormat(emp.gross)},${pesoFormat(emp.deductions)},${pesoFormat(emp.net)}\n`;
        });
      }
      const blob=new Blob([csv],{type:"text/csv"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="payroll.csv";
      link.click();
    }

    // Load from localStorage on page start
    window.onload = function(){
      const savedSites = localStorage.getItem("sites");
      const savedSiteData = localStorage.getItem("siteData");

      if(savedSites && savedSiteData){
        sites = JSON.parse(savedSites);
        siteData = JSON.parse(savedSiteData);

        const select=document.getElementById("perSiteSelect");
        select.innerHTML="";
        sites.forEach(site=>{
          const option=document.createElement("option");
          option.value=site;
          option.textContent=site;
          select.appendChild(option);
        });

        computePayroll();
        console.log("Data loaded:", sites, siteData);
      }
    };
  </script>
</body>
</html>

